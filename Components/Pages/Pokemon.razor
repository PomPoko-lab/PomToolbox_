@page "/pokemon"
@rendermode InteractiveServer
@using PomToolbox.Services.Interfaces
@using PokemonTcgSdk.Standard.Features.FilterBuilder.Pokemon
@using PokemonTcgSdk.Standard.Features.FilterBuilder.Trainer
@using PokemonTcgSdk.Standard.Infrastructure.HttpClients.Set
@using PokemonTcgSdk.Standard.Infrastructure.HttpClients.Cards
@inject IPokemonTcgApiService PokemonTcgApiService
@inject IJSRuntime JSRuntime

@if (searchingInProgress) {
    <Loader />
}

<div class="hero bg-base-200 grow">
    <div class="hero-content text-center mb-10!">
        <div class="max-w-md">
            <form id="pokemon-search-form" @onsubmit="SearchForCards">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="input">
                        <svg class="h-[1em] opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></g></svg>
                        <input @bind-value="searchValue" @bind-value:event="oninput" type="search" class="grow" placeholder="Search" />
                    </label>
                    <select class="select" @bind="searchSeries" @bind:event="onchange" @bind:after="SearchForCards">
                        <option selected value="">Any Series</option>
                        @foreach (string series in setSeries) {
                            <option value="@series">@series</option>
                        }
                    </select>
                </div>
            </form>
        </div>
    </div>
</div>

@if (matchedPokemonCards.Count > 0) {
    <div class="w-full bg-base-200 mb-auto grow">
        <div class="w-full md:w-3xl xl:w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 xl:grid-cols-5 gap-6 justify-items-center">
        @foreach (PokemonCard card in matchedPokemonCards) {
            <div class="card bg-base-100 shadow-md border-primary">
                <figure>
                    <img class="p-3" src="@card?.Images?.Small?.ToString()"/>
                </figure>
                <div class="card-body gap-0 p-5 pt-2">
                    <h2 class="card-title">@card?.Name?.ToString()</h2>
                    <p>@card?.Set?.Name?.ToString()</p>
                    <p>@card?.Rarity?.ToString()</p>
                    <p class="my-2">
                        Market: 
                        <strong>
                            @(card?.Tcgplayer?.Prices?.Holofoil?.Market != null ? "$" + card.Tcgplayer.Prices.Holofoil.Market.ToString("0.00") : "N/A")
                        </strong>
                    </p>
                    <div class="card-actions mt-4 justify-between items-center">
                        <a href="@card?.Tcgplayer?.Url.ToString()" target="_blank">
                            <img class="object-contain max-w-[50px]" src="/assets/logos/tcgplayer-logo.webp" alt="tcgplayer-logo">
                        </a>
                        <button class="btn btn-primary btn-outline btn-circle">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        }
        </div>
    </div>
}


@code {
    private Boolean searchingInProgress = false;
    private List<PokemonCard> matchedPokemonCards = [];
    private string searchValue = "";
    private List<string> setSeries = [
        "Scarlet & Violet",
        "Sword & Shield",
        "Sun & Moon",
        "XY",
    ];
    private string searchSeries = "";

    @* protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            sets = await PokemonTcgApiService.GetSets();
            if (sets.Count > 0) {
                disabledSetsInput = false;
            }
        }
    } *@

    private async Task SearchForCards()
    {
        if (searchValue.Trim().Length == 0) {
            return;
        }
        searchingInProgress = true;

        matchedPokemonCards = await SearchPokemons();

        searchingInProgress = false;
    }

    private async Task<List<PokemonCard>> SearchPokemons() {
        string formattedSearchValue = searchValue.ToLower().Trim();
        PokemonFilterCollection<string, string> pokemonCardsFilter = PokemonFilterBuilder.CreatePokemonFilter();
        pokemonCardsFilter.AddName(searchValue.ToLower() + "*");

        if (searchSeries.Length > 0) {
            pokemonCardsFilter.AddSetSeries(searchSeries);
        }

        return await PokemonTcgApiService.GetPokemonCards(pokemonCardsFilter); 
    }
}
